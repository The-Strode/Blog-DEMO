<%- include("partials/header.ejs") %>

    <!-- Blog post entry form -->

    <div class="blog-form">

    <!-- If-else statement checks if the user is editing a post and displays the appropriate form -->
    
        <% if (locals.editPost===true) { %>

            <div class="section-title">
                <h1>Edit Post</h1>
            </div>

            <!-- Edit Post Form -->

            <form action="/save" method="POST">
                <input type="hidden" name="postIndex" value="<%= postIndex %>">
                <!-- Maintains post identity through edit process, saving to appropriate place in array/database -->
                <h2>Post Title:</h2>
                <input type="text" id="editPostTitle" name="editPostTitle" value="<%= oldTitle %>" required>
                <h3>Post:</h3>
                <textarea id="editPostText" name="editPostText" rows="4" required><%= oldText %></textarea>
                <div class="post-controls">
                    <input type="submit" value="Save Edits">
                    <input type="hidden" id="localTimestamp" name="localTimestamp">
                </div>
            </form>

        <% } else { %>

            <div class="section-title">
                <h1>Create Post</h1>
            </div>

            <!-- Create Post Form -->

            <form action="/submit" method="POST">
                <h2>Post Title:</h2>
                <input type="text" id="newPostTitle" name="newPostTitle" required>
                <h3>Post:</h3>
                <textarea id="newPostText" name="newPostText" rows="4" required></textarea>
                <div class="post-controls">
                    <input type="submit" value="Post Now">
                    <input type="hidden" id="localTimestamp" name="localTimestamp">
                </div>
            </form>

        <% }; %>
    </div>

    <!-- For-loop to display blog posts dynamically -->

    <div class="blog-posts">
        <div class="section-title">
            <h2>All Posts</h2>
        </div>

        <!-- If-else statement determines if there are any posts to display. If not, a message is displayed instead -->

        <% if (locals.posts && locals.posts.length > 0 && locals.texts && locals.texts.length > 0) { %>

            <% for(i=0; i < posts.length; i++) { %>
                <li>
                    <h2>
                        <%= posts[i] %>
                    </h2>
                    <h4>
                        <%= timestamps[i] %>
                    </h4>
                    <p>
                        <%= texts[i] %>
                    </p>
                    <div class="post-controls">
                        <form action="/edit" method="GET">
                            <input type="hidden" name="postIndex" value="<%= i %>">
                            <input type="submit" value="Edit Post" id="editPost<%= i %>">
                        </form>
                        <form action="/delete" method="POST">
                            <input type="hidden" name="postIndex" value="<%= i %>">
                            <input type="submit" value="Delete Post" id="deletePost<%= i %>">
                        </form>
                    </div>
                </li>
            <% }; %>

        <% } else { %>

        <div>
            <h2>No Posts Available</h2>
            <p>It seems there are no posts yet. Why not create one?</p>
        </div>

        <% }; %>
        
    </div>

<script>
function setLocalTimestamp(form) {
    const now = new Date();
    // Format as YYYY-MM-DD HH:mm in local time
    const formatted = now.getFullYear() + "-" +
        String(now.getMonth() + 1).padStart(2, '0') + "-" +
        String(now.getDate()).padStart(2, '0') + " " +
        String(now.getHours()).padStart(2, '0') + ":" +
        String(now.getMinutes()).padStart(2, '0');
    form.querySelector('[name="localTimestamp"]').value = formatted;
}

document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll("form[action='/submit'], form[action='/save']").forEach(form => {
        form.addEventListener("submit", function() {
            setLocalTimestamp(form);
        });
    });
});
</script>

<%- include("partials/footer.ejs") %>